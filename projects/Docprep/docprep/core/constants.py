"""
Централизованные константы для DocPrep.

Содержит все magic numbers, вынесенные из разных модулей для:
- Единообразия конфигурации
- Простоты изменения значений
- Лучшей документируемости
"""

# =============================================================================
# Processing Limits
# =============================================================================

# Максимальное количество классификационных циклов
MAX_CYCLES = 3

# Максимальная глубина рекурсивной распаковки архивов
MAX_EXTRACT_DEPTH = 2

# Максимальная длина имени файла
MAX_FILENAME_LENGTH = 255

# Максимальная длина расширения файла
MAX_EXTENSION_LENGTH = 10


# =============================================================================
# Circuit Breaker
# =============================================================================

# Порог последовательных ошибок для открытия circuit breaker
DEFAULT_CIRCUIT_BREAKER_FAILURE_THRESHOLD = 5

# Время ожидания перед тестированием восстановления (секунды)
DEFAULT_CIRCUIT_BREAKER_RECOVERY_TIMEOUT_SEC = 60

# Количество последних изменений состояния для хранения в метриках
CIRCUIT_BREAKER_HISTORY_SIZE = 5

# Pipeline Circuit Breaker - специфичные настройки для разных компонентов
PIPELINE_CB_FILE_FAILURE_THRESHOLD = 10
PIPELINE_CB_FILE_RECOVERY_TIMEOUT_SEC = 30

PIPELINE_CB_CHUNK_FAILURE_THRESHOLD = 3
PIPELINE_CB_CHUNK_RECOVERY_TIMEOUT_SEC = 60

PIPELINE_CB_STAGE_FAILURE_THRESHOLD = 5
PIPELINE_CB_STAGE_RECOVERY_TIMEOUT_SEC = 120

PIPELINE_CB_EXTERNAL_FAILURE_THRESHOLD = 5
PIPELINE_CB_EXTERNAL_RECOVERY_TIMEOUT_SEC = 300


# =============================================================================
# Xvfb Manager
# =============================================================================

# Минимальное количество дисплеев для пула
XVFB_DEFAULT_MIN_DISPLAYS = 1

# Максимальное количество дисплеев для пула
# ОПТИМИЗАЦИЯ x4: Динамический расчёт на основе CPU и памяти
# На 64-ядерном сервере с 16GB RAM: max 21 дисплей (1 на 3 CPU)
def _calculate_max_displays() -> int:
    """Динамически рассчитывает максимальное количество Xvfb дисплеев.

    x4 оптимизация: 1 дисплей на 3 CPU вместо 10.
    """
    import os
    cpu_count = os.cpu_count() or 4

    # x4: 1 дисплей на 3 CPU, максимум 24
    cpu_based = max(2, min(24, cpu_count // 3))

    # Проверяем память если доступен psutil
    try:
        import psutil
        available_gb = psutil.virtual_memory().available / (1024 ** 3)
        # LibreOffice требует ~512MB на процесс (оптимизировано)
        memory_based = max(2, min(24, int(available_gb / 0.75)))
        return min(cpu_based, memory_based)
    except ImportError:
        return cpu_based

XVFB_DEFAULT_MAX_DISPLAYS = _calculate_max_displays()

# Базовый номер дисплея (Xvfb начнёт с :99)
XVFB_DEFAULT_BASE_DISPLAY = 99

# Таймаут ожидания дисплея из пула (секунды)
# ОПТИМИЗАЦИЯ: Увеличено для многопоточной работы
XVFB_ACQUIRE_TIMEOUT_SEC = 60

# Таймаут завершения процесса Xvfb (секунды)
XVFB_PROCESS_TERMINATE_TIMEOUT_SEC = 5

# Таймаут проверки pgrep (секунды)
XVFB_PGREP_TIMEOUT_SEC = 5

# Задержка после запуска Xvfb (секунды)
XVFB_STARTUP_DELAY_SEC = 2

# Интервал повтора при ожидании дисплея (секунды)
XVFB_RETRY_INTERVAL_SEC = 0.1


# =============================================================================
# LibreOffice Converter
# =============================================================================

# Таймаут конвертации документа (секунды)
LIBREOFFICE_DEFAULT_TIMEOUT_SEC = 300

# Максимальная длина сообщения об ошибке для логирования
ERROR_MESSAGE_TRUNCATE_LENGTH = 200


# =============================================================================
# Chunked Processing
# =============================================================================

# Размер чанка по умолчанию
# ОПТИМИЗАЦИЯ: Увеличен до 200 для больших объёмов данных (было 100)
DEFAULT_CHUNK_SIZE = 200

# Максимальное количество повторных попыток для чанка
DEFAULT_MAX_CHUNK_RETRIES = 3

# Максимальное время обработки (секунды)
DEFAULT_MAX_PROCESSING_TIME_SEC = 3600


# =============================================================================
# Security / Limits
# =============================================================================

# Максимальный размер zip-архива для защиты от zip-bomb (байты, ~1 ГБ)
ZIP_BOMB_MAX_SIZE_BYTES = 1_000_000_000

# Максимальный коэффициент распаковки для защиты от zip-bomb
ZIP_BOMB_MAX_RATIO = 100


# =============================================================================
# Thresholds and Reporting
# =============================================================================

# Порог успешной обработки для считания batch завершённым (%)
SUCCESS_COMPLETION_THRESHOLD_PERCENT = 95.0

# Максимальное количество сообщений об ошибках в отчёте
MAX_ERROR_MESSAGES_IN_REPORT = 3


# =============================================================================
# File Operations
# =============================================================================

# Размер буфера для чтения файлов (байты)
FILE_READ_BUFFER_SIZE = 8192

# Таймаут для операций с файловой системой (секунды)
FS_OPERATION_TIMEOUT_SEC = 30


# =============================================================================
# Retry Policy
# =============================================================================

# Количество попыток по умолчанию
DEFAULT_RETRY_COUNT = 3

# Базовая задержка между попытками (секунды)
DEFAULT_RETRY_DELAY_SEC = 1.0

# Максимальная задержка между попытками (секунды)
MAX_RETRY_DELAY_SEC = 30.0

# Экспоненциальный коэффициент для backoff
RETRY_BACKOFF_MULTIPLIER = 2.0
